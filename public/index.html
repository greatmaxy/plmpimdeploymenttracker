<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deployment Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Deployment Tracker</h1>

  <!-- Buttons to switch datasets -->
  <div id="filterButtons">
    <button onclick="loadDeployments('V2MIBSCPSILVER')">V2MIBSCPSILVER</button>
    <button onclick="loadDeployments('PREARU')">PREARU</button>
    <button onclick="loadDeployments('ARU')">ARU</button>
  </div>

  <div class="container" id="deploymentContainer"></div>

  <script>
    async function loadDeployments(dataset) {
      let dataFile = "data.json"; // Default dataset
      if (dataset === "PREARU") dataFile = "dataPreARU.json";
      if (dataset === "ARU") dataFile = "dataARU.json";

      const response = await fetch(`/api/deployments?file=${dataFile}`);
      const deployments = await response.json();

      const container = document.getElementById("deploymentContainer");
      container.innerHTML = ""; // Clear previous content

      deployments.forEach((deployment) => {
        const statusClass =
          deployment.status === "FAILED"
            ? "status-failed"
            : deployment.status === "SUCCESS"
            ? "status-success"
            : "status-in-progress";

        // Render each deployment card
        const card = `
          <div class="card">

            <div class="status-box ${statusClass}"></div>
            <div>
            <div class="details">
              <h2>Deployment #${deployment.id} â€“ ${deployment.week} (${deployment.date})</h2>
              <ul>
                <li> ${deployment.status}</li>
                <li> Automation triggered: ${deployment.automationTriggered}</li>
                <li> BATs triggered: ${deployment.batsTriggered}</li>
                <li> BATs Passed/Failed: ${deployment.batsResult}</li>
                <li> Consolidated txn: <a href="${deployment.txnLink}" target="_blank">Link</a></li>
                <li> LRG Report: ${
                  deployment.lrgReportLink !== "NA"
                    ? `<a href="${deployment.lrgReportLink}" target="_blank">Link</a>`
                    : "NA"
                }</li>
              </ul>
            </div>
            <div class="actions">
              <button onclick="toggleTransactions(${deployment.id})">Included Txns</button>
              <button onclick="openReport('${deployment.id}')">BATS Report</button>
              <button onclick="openEnvs('${deployment.id}')">Available in Envs</button>
              <div class="transactions" id="txn-${deployment.id}" style="display: none;">
                ${deployment.transactions
                  .map((txn) => `<div class="txn-item">${txn}</div>`)
                  .join("")}
              </div>
            </div>
            </div>
          </div>
        `;

        container.innerHTML += card;
      });
    }

    // Function to toggle the visibility of transactions
    function toggleTransactions(id) {
      const txnDiv = document.getElementById(`txn-${id}`);
      txnDiv.style.display = txnDiv.style.display === "none" ? "block" : "none";
    }

    // Placeholder for "BATS Report" button functionality
    function openReport(deploymentId) {
      alert(`Opening BATS report for deployment #${deploymentId}...`);
    }

    // Placeholder for "Available in Envs" button functionality
    function openEnvs(deploymentId) {
      alert(`Opening available environments for deployment #${deploymentId}...`);
    }

    // Load the default dataset on page load
    loadDeployments("V2MIBSCPSILVER");
  </script>
</body>
</html>
