<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLM PIM Deployment Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>PLM PIM Deployment Tracker</h1>

  <!-- Buttons to switch datasets -->
  <div id="filterButtons">
    <button onclick="loadDeployments('V2MIBSCPSILVER')">V2MIBSCPSILVER</button>
    <button onclick="loadDeployments('PREARU')">PREARU</button>
    <button onclick="loadDeployments('ARU')">ARU</button>
  </div>

  <div class="container" id="deploymentContainer"></div>

  <script>
    async function loadDeployments(dataset) {
      let dataFile = "data.json"; // Default dataset
      if (dataset === "PREARU") dataFile = "dataPreARU.json";
      if (dataset === "ARU") dataFile = "dataARU.json";

      const response = await fetch(`/api/deployments?file=${dataFile}`);
      const deployments = await response.json();

      const container = document.getElementById("deploymentContainer");
      container.innerHTML = ""; // Clear previous content

      deployments.forEach((deployment) => {
        const statusClass =
          deployment.status === "FAILED"
            ? "status-failed"
            : deployment.status === "SUCCESS"
            ? "status-success"
            : "status-in-progress";

        // Render each deployment card
        const card = `
          <div class="card">

            <div class="status-box ${statusClass}"></div>
            <div class="details-and-actions">
            <div class="details">
              <h2>Deployment #${deployment.id} – ${deployment.week} (${deployment.date})</h2>
              <ul>
                <li> ${deployment.status}</li>
                <li> Automation triggered: ${deployment.automationTriggered}</li>
                <li> BATs triggered: ${deployment.batsTriggered}</li>
                <li> BATs Passed/Failed: ${deployment.batsResult}</li>
                <li> Consolidated txn: <a href="${deployment.txnLink}" target="_blank">Link</a></li>
                <li> LRG Report: ${
                  deployment.lrgReportLink !== "NA"
                    ? `<a href="${deployment.lrgReportLink}" target="_blank">Link</a>`
                    : "NA"
                }</li>
              </ul>
            </div>
            <div class="actions">
              <button onclick="toggleTransactions(${deployment.id})">Included Txns</button>
              <button onclick="openReport('${deployment.id}')">BATS Report</button>
              <button onclick="openEnvs('${deployment.id}')">Available in Envs</button>
              <div class="transactions" id="txn-${deployment.id}" style="display: none;">
                ${deployment.transactions
                  .map((txn) => `<div class="txn-item">${txn}</div>`)
                  .join("")}
              </div>

              <table id="bats-report-${deployment.id}" class="bats-report-table" style="display: none;">
                <tr>
                  <th></th>
                  <th>PIM</th>
                  <th>PLM</th>
                </tr>
                <tr>
                  <td>Disposition</td>
                  <td>${deployment.batsReport.pimPlmDisposition.disposition.pim}</td>
                  <td>${deployment.batsReport.pimPlmDisposition.disposition.plm}</td>
                </tr>
                <tr>
                  <td>Comments</td>
                  <td>${deployment.batsReport.pimPlmDisposition.comments.pim}</td>
                  <td>${deployment.batsReport.pimPlmDisposition.comments.plm}</td>
                </tr>
              </table>

              <table id="bats-report-2-${deployment.id}" class="bats-report-table2" style="display: none;">
                <tr>
                  <th>Product Name</th>
                  <th>Total</th>
                  <th>Pass</th>
                  <th>Fail</th>
                </tr>
               <tr>
                  <th>Product Lifecycle Portfolio Managment</th>
                  <th>${deployment.batsReport.productName.plpm.total}</th>
                  <th>${deployment.batsReport.productName.plpm.pass}</th>
                  <th>${deployment.batsReport.productName.plpm.fail}</th>
                </tr>
                <tr>
                  <th>Product Development</th>
                  <th>${deployment.batsReport.productName.pd.total}</th>
                  <th>${deployment.batsReport.productName.pd.total}</th>
                  <th>${deployment.batsReport.productName.pd.total}</th>
                </tr>
                 <tr>
                  <th>Quality Issue And Action Management</th>
                  <th>${deployment.batsReport.productName.qiam.total}</th>
                  <th>${deployment.batsReport.productName.qiam.total}</th>
                  <th>${deployment.batsReport.productName.qiam.total}</th>
                </tr>
                <tr>
                  <th>Product Requiremnt and Ideation Management</th>
                  <th>${deployment.batsReport.productName.prim.total}</th>
                  <th>${deployment.batsReport.productName.prim.total}</th>
                  <th>${deployment.batsReport.productName.prim.total}</th>
                </tr>
                 <tr>
                  <th>Product Concept Design</th>
                  <th>${deployment.batsReport.productName.pcd.total}</th>
                  <th>${deployment.batsReport.productName.pcd.total}</th>
                  <th>${deployment.batsReport.productName.pcd.total}</th>
                </tr>
              </table>
              
              <table id="env-links-${deployment.id}" class="env-links-table" style="display: none;">
                <tr>
                  <td>Environment -> Local QA Docker</td>
                  <td><a href="${deployment.envLinks.qaDocker}" target="_blank">${deployment.envLinks.qaDocker}</a></td>
                </tr>
                <tr>
                  <td>Environment ->  SCM Silver FAaaS Unlocked Opt-In – CPTAXGBQY</td>
                  <td><a href="${deployment.envLinks.silverUnlockedOptIn}" target="_blank">${deployment.envLinks.silverUnlockedOptIn}</a></td>
                </tr>
                <tr>
                  <td>Environment -> SCM Silver FAaaS Unlocked Opt-Out - CPTAZGUQY</td>
                  <td><a href="${deployment.envLinks.silverUnlockedOptOut}" target="_blank">${deployment.envLinks.silverUnlockedOptOut}</a></td>
                </tr>
              </table>


              

            </div>
            </div>
          </div>
        `;

        container.innerHTML += card;
      });
    }

    // Function to toggle the visibility of transactions
    function toggleTransactions(id) {
      const txnDiv = document.getElementById(`txn-${id}`);
      const batsReport = document.getElementById(`bats-report-${id}`);
      const batsReport2 = document.getElementById(`bats-report-2-${id}`);
      const envLinks = document.getElementById(`env-links-${id}`);
      txnDiv.style.display = txnDiv.style.display === "none" ? "block" : "none";
      batsReport.style.display = "none";
      batsReport2.style.display = "none";
      envLinks.style.display = "none";
    }

    // Placeholder for "BATS Report" button functionality
    function openReport(deploymentId) {
      const batsReport = document.getElementById(`bats-report-${deploymentId}`);
      const batsReport2 = document.getElementById(`bats-report-2-${deploymentId}`);
      const txnDiv = document.getElementById(`txn-${deploymentId}`);
      const envLinks = document.getElementById(`env-links-${deploymentId}`);

      batsReport.style.display = batsReport.style.display === "none" ? "block" : "none";
      batsReport2.style.display = batsReport2.style.display === "none" ? "block" : "none";

      txnDiv.style.display = "none";
      envLinks.style.display = "none";
    }

    // Placeholder for "Available in Envs" button functionality
    function openEnvs(deploymentId) {

      const batsReport = document.getElementById(`bats-report-${deploymentId}`);
      const batsReport2 = document.getElementById(`bats-report-2-${deploymentId}`);
      const txnDiv = document.getElementById(`txn-${deploymentId}`);
      const envLinks = document.getElementById(`env-links-${deploymentId}`);

      batsReport.style.display = "none";
      txnDiv.style.display = "none";
      batsReport2.style.display = "none";

      envLinks.style.display = envLinks.style.display === "none" ? "block" : "none";
    }

    // Load the default dataset on page load
    loadDeployments("V2MIBSCPSILVER");
  </script>
</body>
</html>
